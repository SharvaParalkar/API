<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FilamentBros Order Dashboard</title>
  <style>
    body {
      font-family: "Roboto", sans-serif;
      margin: 0;
      padding: 2rem;
      background-color: #f5f5f5;
    }

    h1 {
      text-align: center;
      color: #1f6463;
      margin-bottom: 1rem;
    }

    .search-container {
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 0 1rem;
    }

    .search-container input {
      width: 100%;
      max-width: 700px;
      flex: 1;
      padding: 0.75rem;
      font-size: 1rem;
      border: 2px solid #ccc;
      border-radius: 5rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      align-items: start;
    }

    .card {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 1.25rem;
      color: #333;
      position: relative;
      height: auto;
    }

    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: #1f6463;
      margin: 0 0 0.75rem 0;
    }

    .card ul {
      padding-left: 1rem;
      margin: 0;
      font-size: 0.95rem;
      list-style: disc;
    }

    .card:hover {
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
      transform: translateY(-3px);
      transition: 0.2s ease;
    }

    .card ul li {
      margin-bottom: 0.5rem;
    }

    .order-id {
      margin-top: 1.25rem;
      padding-top: 0.75rem;
      border-top: 1px solid #ddd;
      text-align: center;
      font-size: 0.8rem;
      color: #666;
      font-weight: bold;
    }

    .stl-header {
      font-weight: bold;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }

    .stl-list {
      padding-left: 1.2rem;
      list-style-type: disc;
      margin-top: 0;
      margin-bottom: 0.75rem;
    }

    .stl-list li {
      font-size: 0.9rem;
      margin-bottom: 0.35rem;
    }

    .stl-link {
      display: block;
      max-width: 100%;
      color: #1f6463;
      text-decoration: none;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
      word-break: break-word;
      /* Ensures long words break cleanly */
    }

    .download-all-btn {
      margin-top: 0.25rem;
      display: inline-block;
      margin-top: 0.5rem;
      padding: 0.4rem 0.75rem;
      background-color: #1f6463;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.85rem;
    }

    .status-submitted {
      background-color: #1f6463;
    }

    .status-complete {
      background-color: #5cb85c;
    }

    .status-failed {
      background-color: #d9534f;
    }

    .details-toggle {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #1f6463;
      background: none;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    .details-section {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.6s ease, opacity 0.6s ease;
      opacity: 0;
      margin-top: 0;
    }

    .details-section.visible {
      max-height: 1000px;
      /* large enough to cover any content height */
      opacity: 1;
      margin-top: 0.75rem;
    }

    .details-table {
      width: 100%;
      font-size: 0.9rem;
      border-spacing: 0.4rem 0.25rem;
    }

    .details-table td {
      vertical-align: top;
      padding: 0.2rem 0.5rem;
    }

    .details-table td:first-child {
      font-weight: bold;
      width: 30%;
    }

    .status-dropdown {
      padding: 0.4rem;
      border-radius: 1rem;
      border: 1px solid #ccc;
      margin-left: 0.5rem;
      max-height: 100px;
      overflow-y: auto;
    }

    .status-dropdown option {
      padding: 0.3rem;
    }

    .status-dropdown option:checked {
      background-color: #1f6463;
      color: white;
    }

    .status-pending {
      background-color: #ff6e5f;
      color: #000;
    }

    .status-pre-print {
      background-color: #ffaea5;
      color: #000;
    }

    .status-printing {
      background-color: #f4d03f;
      color: #000;
    }

    .status-printing-pay-later {
      background-color: #f4d03f;
      color: #000;
    }

    .status-completed {
      background-color: #2ecc71;
      color: #000;
    }

    .toggle-wrapper {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }

    .toggle-wrapper input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 24px;
    }

    .slider::before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-wrapper input:checked+.slider {
      background-color: #1f6463;
    }

    .toggle-wrapper input:checked+.slider::before {
      transform: translateX(20px);
    }

    .toggle-label {
      font-size: 0.9rem;
      margin-left: 0.5rem;
      line-height: 24px;
      color: #333;
    }

    .top-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 2rem;
      flex-direction: column;
    }

    .toggle-group {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .login-box {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 360px;
      text-align: center;

      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .login-box input[type="text"],
    .login-box input[type="password"] {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      box-sizing: border-box;
      /* ✅ prevents padding from adding to width */
    }

    .login-box button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      background-color: #1f6463;
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
    }

    .login-box .remember-line {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      justify-content: left;
    }

    .toggles-wrapper {
      display: flex;
      gap: 1rem;
    }

    .search-input-wrapper {
      flex-grow: 1;
      max-width: 700px;
      margin: 0 auto;
    }

    .search-bar-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
      height: 3.5rem;
    }

    .toggles-wrapper {
      position: absolute;
      left: 0;
      display: flex;
      gap: 1rem;
      align-items: center;
      padding-left: 1rem;
    }

    .centered-search {
      max-width: 700px;
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: 2px solid #ccc;
      border-radius: 5rem;
    }

    .search-bar-flex {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
      width: 100%;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      padding: 0 1rem;
    }

    .left-toggles {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-shrink: 0;
    }

    .center-search {
      flex-grow: 1;
      max-width: 700px;
      display: flex;
      justify-content: center;
    }

    .center-search input {
      width: 100%;
      max-width: 700px;
      padding: 0.75rem;
      font-size: 1rem;
      border: 2px solid #ccc;
      border-radius: 5rem;
      outline: none;
    }

    .center-search input:focus {
      border-color: #1f6463;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .status-history {
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    .status-history-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
    }

    .status-history-item:last-child {
      border-bottom: none;
    }

    .staff-notes-editor {
      width: 100%;
      min-height: 80px;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 0.3rem;
      margin-top: 0.3rem;
      font-family: inherit;
      font-size: 0.9rem;
      resize: vertical;
    }

    .save-notes-btn {
      margin-top: 0.5rem;
      padding: 0.4rem 0.8rem;
      background-color: #1f6463;
      color: white;
      border: none;
      border-radius: 0.3rem;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .save-notes-btn:hover {
      background-color: #184f4e;
    }

    .save-notes-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .dark-mode {
      background-color: #1a1a1a;
      color: #fff;
    }

    .dark-mode .card {
      background-color: #2d2d2d;
      color: #fff;
    }

    .dark-mode .status-dropdown {
      background-color: #3d3d3d;
      color: #fff;
      border-color: #4d4d4d;
    }

    .dark-mode .staff-notes-editor {
      background-color: #3d3d3d;
      color: #fff;
      border-color: #4d4d4d;
    }

    .dark-mode-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background-color: #1f6463;
      color: white;
      border: none;
      cursor: pointer;
    }

    .priority-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 0.3rem;
      font-size: 0.8rem;
      margin-left: 0.5rem;
    }

    .priority-high {
      background-color: #ff4444;
      color: white;
    }

    .priority-medium {
      background-color: #ffbb33;
      color: black;
    }

    .priority-low {
      background-color: #00C851;
      color: white;
    }

    .tab-container {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
      position: relative;
      z-index: 100;
    }

    .tab-button {
      padding: 0.6rem 1rem;
      border-radius: 1rem;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s ease;
      user-select: none;
      pointer-events: auto;
    }

    .tab-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tab-button:active {
      transform: translateY(0);
    }

    /* Add consistent button styles */
    .action-button {
      border: none;
      color: #333;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
      transition: all 0.2s ease;
      background-color: #ccc;
      cursor: pointer;
    }

    .action-button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    .action-button.claiming,
    .action-button.unclaiming {
      background-color: #999;
      cursor: not-allowed;
    }

    /* Add styles for the staff list display */
    .assigned-staff-list {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .staff-tag {
      background-color: #e0e0e0;
      color: #333;
      padding: 0.4rem 0.8rem;
      border-radius: 0.5rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .staff-tag.selected {
      background-color: #1f6463;
      color: white;
      transform: scale(1.02);
    }

    .staff-tag:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .staff-tag:active {
      transform: scale(0.98);
    }

    .staff-selection-container {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .staff-tags-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.5rem;
      border-radius: 0.5rem;
      background-color: #f5f5f5;
    }

    /* Replace the old staff dropdown styles */
    .staff-dropdown {
      display: none;
    }
  </style>
</head>

<body>
  <h1>FilamentBros Order Dashboard</h1>

  <div class="tab-container">
    <button id="tabAll" class="tab-button"
      style="background: #1f6463; color: white;">All Orders</button>
    <button id="tabClaimed" class="tab-button"
      style="background: #ccc; color: black;">Claimed Orders</button>
  </div>

  <div class="search-bar-flex">
    <div class="left-toggles">
      <div class="toggle-group">
        <span class="toggle-label">Old Orders</span>
        <label class="toggle-wrapper">
          <input type="checkbox" id="showOldToggle" />
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-group">
        <span class="toggle-label">Completed</span>
        <label class="toggle-wrapper">
          <input type="checkbox" id="showCompletedToggle" />
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-group">
        <select id="staffFilter" style="padding: 0.4rem; border-radius: 0.3rem; border: 1px solid #ccc;">
          <option value="">All Staff</option>
        </select>
      </div>
    </div>

    <div class="center-search">
      <input type="text" id="searchInput" placeholder="Search by name, email, phone, or order ID..." />
    </div>
  </div>

  <div class="grid" id="orderGrid"></div>

  <script>
    // Constants
    const REFRESH_INTERVAL = 10000; // 10 seconds
    const SEARCH_DEBOUNCE = 200; // 200ms
    const MAX_RETRY_ATTEMPTS = 3;
    const VALID_STATUSES = [
      "pending",
      "pre print",
      "printing",
      "printing pay later",
      "completed",
    ];

    // State management
    const state = {
      allOrders: [],
      currentUser: null,
      currentTab: "all",
      retryCount: 0,
      filters: {
        showOld: false,
        showCompleted: false,
        staffFilter: ""
      },
      intervals: [],
      staffMembers: [],
      lastOrderHash: null,
      lastRefreshTime: 0,
      minRefreshInterval: 5000
    };

    // First full load
    async function loadInitialOrders() {
      try {
        const data = await api.fetchOrders();
        state.allOrders = Array.isArray(data) ? data : [];
        console.log('📦 Initial orders loaded:', state.allOrders.length);

        // Initialize search immediately after orders load
        initializeSearch();

        // Apply any existing search query
        const query = document.getElementById("searchInput").value;
        filterOrders(query);
      } catch (err) {
        state.allOrders = [];
        document.getElementById("orderGrid").innerHTML = "<p>⚠️ Failed to load orders.</p>";
        console.error("❌ Failed to load initial orders:", err);
      }
    }

    // Handle incoming order updates
    function handleOrderUpdate(updatedOrder) {
      console.log('🔄 Processing order update:', updatedOrder);

      // Update order in state
      const index = state.allOrders.findIndex(order => order.id === updatedOrder.id);
      if (index !== -1) {
        state.allOrders[index] = updatedOrder;
      } else {
        state.allOrders.unshift(updatedOrder);
        // Only auto-estimate for new orders if they don't have a price
        if (!updatedOrder.est_price && 
            !(updatedOrder.order_notes && updatedOrder.order_notes.includes("Print estimate failed"))) {
          console.log(`🔄 Running auto-estimate for new order ${updatedOrder.id}`);
          const card = document.querySelector(`[data-order-id="${updatedOrder.id}"]`);
          if (card) {
            autoEstimateOrder(updatedOrder, card);
          }
        } else {
          console.log(`⏭️ Skipping auto-estimate for new order ${updatedOrder.id} - price exists: $${updatedOrder.est_price}`);
        }
      }

      // Get the existing card if it exists
      const orderCard = document.querySelector(`[data-order-id="${updatedOrder.id}"]`);
      
      // Handle claimed tab visibility
      if (state.currentTab === "claimed") {
        const shouldBeVisible = updatedOrder.claimed_by === state.currentUser && 
                              updatedOrder.assigned_staff === state.currentUser &&
                              updatedOrder.status?.toLowerCase() !== "completed";
        
        if (!shouldBeVisible && orderCard) {
          // Smoothly remove the card if it shouldn't be visible
          orderCard.style.transition = "all 0.3s ease";
          orderCard.style.opacity = "0";
          orderCard.style.transform = "scale(0.9)";
          setTimeout(() => orderCard.remove(), 300);
          return;
        }
      }

      if (orderCard) {
        // Update existing card
        const claimBtn = orderCard.querySelector('button:last-child');
        const unclaimBtn = orderCard.querySelector('button[textContent="Unclaim"]');
        
        // Update status dropdown
        const statusDropdown = orderCard.querySelector('.status-dropdown');
        if (statusDropdown) {
          const newStatus = updatedOrder.status || 'pending';
          console.log(`🔄 Updating status for order ${updatedOrder.id} to:`, newStatus);
          
          // First update the dropdown value
          statusDropdown.value = newStatus;
          statusDropdown.dataset.previousValue = newStatus;
          
          // Then update the visual style
          applyStatusColor(statusDropdown, newStatus);
          
          // Verify the update
          console.log(`✅ Status updated - Current value: ${statusDropdown.value}, Previous value: ${statusDropdown.dataset.previousValue}`);
        } else {
          console.warn(`⚠️ No status dropdown found for order ${updatedOrder.id}`);
        }

        // Update staff tags
        const assignedStaff = updatedOrder.assigned_staff ? updatedOrder.assigned_staff.split(',') : [];
        updateStaffTagsForOrder(orderCard, assignedStaff);

        // Update details section if open
        const detailsSection = orderCard.querySelector('.details-section');
        if (detailsSection?.classList.contains('visible')) {
          // Update staff notes
          const notesCell = [...detailsSection.querySelectorAll('td')].find(td => 
            td.textContent.trim().startsWith('Staff Notes:')
          )?.nextElementSibling;
          if (notesCell) {
            notesCell.textContent = updatedOrder.order_notes || '—';
          }

          // Update last updated by
          const updatedByCell = [...detailsSection.querySelectorAll('td')].find(td => 
            td.textContent.trim().startsWith('Last Updated By:')
          )?.nextElementSibling;
          if (updatedByCell) {
            updatedByCell.textContent = updatedOrder.updated_by || '—';
          }
        }

        // Handle claim/unclaim button updates
        if (updatedOrder.claimed_by === state.currentUser) {
          // If claimed by current user, show unclaim button
          if (claimBtn && !unclaimBtn) {
            claimBtn.replaceWith(createUnclaimButton(updatedOrder));
          }
        } else {
          // If not claimed by current user, show appropriate claim button
          if (claimBtn || unclaimBtn) {
            const newClaimBtn = document.createElement('button');
            newClaimBtn.className = 'action-button';
            newClaimBtn.dataset.orderId = updatedOrder.id;
            
            if (updatedOrder.claimed_by) {
              newClaimBtn.textContent = `Claimed by ${updatedOrder.claimed_by}`;
              newClaimBtn.disabled = true;
            } else {
              newClaimBtn.textContent = 'Claim Order';
              
              // Add claim functionality
              newClaimBtn.addEventListener('click', async () => {
                try {
                  newClaimBtn.textContent = 'Claiming...';
                  newClaimBtn.disabled = true;
                  newClaimBtn.classList.add('claiming');

                  const response = await api.claimOrder(updatedOrder.id);
                  
                  if (response && response.order) {
                    // Update the entire order object with the response
                    Object.assign(updatedOrder, response.order);
                    
                    // Update the status dropdown if it exists
                    const statusDropdown = orderCard.querySelector('.status-dropdown');
                    if (statusDropdown) {
                      const newStatus = response.order.status || 'pending';
                      console.log(`🔄 Setting initial status for claimed order ${updatedOrder.id} to:`, newStatus);
                      statusDropdown.value = newStatus;
                      statusDropdown.dataset.previousValue = newStatus;
                      applyStatusColor(statusDropdown, newStatus);
                    }
                    
                    // Update staff tags
                    updateStaffTagsForOrder(orderCard, [state.currentUser]);
                    
                    // Replace claim button with unclaim button
                    newClaimBtn.replaceWith(createUnclaimButton(updatedOrder));
                  }
                } catch (err) {
                  console.error(`Failed to claim order ${updatedOrder.id}:`, err);
                  ui.showError(err.message || "Failed to claim order");
                  newClaimBtn.textContent = 'Claim Order';
                  newClaimBtn.disabled = false;
                  newClaimBtn.classList.remove('claiming');
                }
              });
            }

            if (claimBtn) {
              claimBtn.replaceWith(newClaimBtn);
            } else if (unclaimBtn) {
              unclaimBtn.replaceWith(newClaimBtn);
            }
          }
        }
      }
    }

    // Function to update staff tags based on assigned staff
    function updateStaffTagsForOrder(orderCard, assignedStaff) {
      const staffTags = orderCard.querySelectorAll('.staff-tag');
      staffTags.forEach(tag => {
        const staffMember = state.staffMembers.find(s => s.displayName === tag.textContent);
        if (staffMember) {
          tag.classList.toggle('selected', assignedStaff.includes(staffMember.username));
        }
      });
    }

    // Helper function to create unclaim button
    function createUnclaimButton(order) {
      const unclaimBtn = document.createElement('button');
      unclaimBtn.textContent = 'Unclaim';
      unclaimBtn.className = 'action-button';
      unclaimBtn.dataset.orderId = order.id;

      let isUnclaiming = false;

      unclaimBtn.addEventListener('click', async () => {
        if (isUnclaiming) return;
        
        try {
          isUnclaiming = true;
          unclaimBtn.textContent = 'Unclaiming...';
          unclaimBtn.disabled = true;
          unclaimBtn.classList.add('unclaiming');

          const unclaimResponse = await api.unclaimOrder(order.id);
          
          // Get the card element
          const orderCard = document.querySelector(`[data-order-id="${order.id}"]`);
          if (!orderCard) {
            console.error(`Could not find order card for ${order.id}`);
            throw new Error('Could not find order card');
          }

          // Update state.allOrders
          const orderIndex = state.allOrders.findIndex(o => o.id === order.id);
          if (orderIndex !== -1) {
            state.allOrders[orderIndex] = unclaimResponse.order;
          }

          if (state.currentTab === "claimed") {
            // In claimed tab, just remove the card smoothly
            orderCard.style.transition = "all 0.3s ease";
            orderCard.style.opacity = "0";
            orderCard.style.transform = "scale(0.9)";
            setTimeout(() => {
              const cardStillExists = document.querySelector(`[data-order-id="${order.id}"]`);
              if (cardStillExists) {
                cardStillExists.remove();
              }
            }, 300);
          } else {
            // In all tab, update the card
            // Update status dropdown
            const statusDropdown = orderCard.querySelector('.status-dropdown');
            if (statusDropdown) {
              const newStatus = unclaimResponse.order.status || 'pending';
              statusDropdown.value = newStatus;
              statusDropdown.dataset.previousValue = newStatus;
              applyStatusColor(statusDropdown, newStatus);
            }

            // Update staff tags
            const staffList = unclaimResponse.order.assigned_staff ? unclaimResponse.order.assigned_staff.split(',') : [];
            updateStaffTagsForOrder(orderCard, staffList);
            
            // Create new claim button
            const claimBtn = document.createElement('button');
            claimBtn.textContent = 'Claim Order';
            claimBtn.className = 'action-button';
            claimBtn.dataset.orderId = order.id;
            
            let isClaiming = false;
            
            claimBtn.addEventListener('click', async () => {
              if (isClaiming) return;
              
              try {
                isClaiming = true;
                claimBtn.textContent = 'Claiming...';
                claimBtn.disabled = true;
                claimBtn.classList.add('claiming');
                
                const claimResponse = await api.claimOrder(order.id);
                
                if (!claimResponse || !claimResponse.order) {
                  throw new Error('Failed to claim order');
                }

                // Update the card
                const cardToUpdate = document.querySelector(`[data-order-id="${order.id}"]`);
                if (!cardToUpdate) {
                  throw new Error('Could not find order card');
                }

                // Update status
                const statusDropdown = cardToUpdate.querySelector('.status-dropdown');
                if (statusDropdown) {
                  const newStatus = claimResponse.order.status || 'pending';
                  statusDropdown.value = newStatus;
                  statusDropdown.dataset.previousValue = newStatus;
                  applyStatusColor(statusDropdown, newStatus);
                }
                
                // Update staff tags
                const staffToAssign = claimResponse.order.assigned_staff ? claimResponse.order.assigned_staff.split(',') : [];
                updateStaffTagsForOrder(cardToUpdate, staffToAssign);
                
                // Update state
                const stateIndex = state.allOrders.findIndex(o => o.id === order.id);
                if (stateIndex !== -1) {
                  state.allOrders[stateIndex] = { ...claimResponse.order };
                }
                
                // Replace button
                claimBtn.replaceWith(createUnclaimButton(claimResponse.order));
              } catch (err) {
                console.error(`Failed to claim order ${order.id}:`, err);
                ui.showError(err.message || "Failed to claim order");
                claimBtn.textContent = 'Claim Order';
                claimBtn.disabled = false;
                claimBtn.classList.remove('claiming');
              } finally {
                isClaiming = false;
              }
            });
            
            unclaimBtn.replaceWith(claimBtn);
          }
        } catch (err) {
          console.error(`Failed to unclaim order ${order.id}:`, err);
          ui.showError(err.message || "Failed to unclaim order");
          unclaimBtn.textContent = 'Unclaim';
          unclaimBtn.disabled = false;
          unclaimBtn.classList.remove('unclaiming');
        } finally {
          isUnclaiming = false;
        }
      });

      return unclaimBtn;
    }
  </script>

  <div id="loginOverlay" class="login-overlay">
    <div class="login-box">
      <h2>FilamentBros Login</h2>
      <form id="loginForm">
        <input type="text" id="username" placeholder="Username" required />
        <input type="password" id="password" placeholder="Password" required />
        <label class="remember-line">
          <input type="checkbox" id="rememberMe" />
          Remember Me
        </label>
        <button type="submit">Login</button>
        <p id="loginError" style="color: red; display: none; font-size: 0.85rem"></p>
      </form>
    </div>
  </div>
</body>

</html>